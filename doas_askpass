#!/usr/bin/expect --

# askpass implementation for doas
# Example usage: DOAS_ASKPASS="dmenu -P -p password:" doas_askpass echo working

# Don't mind the man behind the curtain
log_user 0

# No command, then nothing to do
if { $argc == 0 } { exit 0 }

# Treat all arguments as command input
set cmd [lrange $argv 0 end]
set timeout 3

# Read askpass from env or fallback
if {[info exists ::env(DOAS_ASKPASS)]} {
    set askpass "$::env(DOAS_ASKPASS)"
} else {
    set askpass "Password:"
}

# Safe read password from user
if { [catch {set pwd [exec {*}$askpass]} err] } {
    puts stderr "askpass failed: $err"
    exit 1
}

# Spawn doas operation
spawn doas {*}$cmd

# Send password and execute command
expect {
    "doas*password:" { send -- "$pwd\r" }
    "Password:" { send -- "$pwd\r" }
    timeout {
        puts stderr "doas timeout - no password prompt"
        exit 1
    }
}

expect eof
log_user 1
